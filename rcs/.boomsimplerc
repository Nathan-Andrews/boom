#!/usr/bin/env bash

_exportEmojis() {
  echo -n "_BE_BOOM=$_BE_BOOM _BE_HOLE=$_BE_HOLE "
  echo -n "_BE_BOT=$_BE_BOT _BE_SUPER=$_BE_SUPER "
  echo -n "_BE_HOG=$_BE_HOG _BE_IMPORT=$_BE_IMPORT "
  echo    _BE_EXPORT=$_BE_EXPORT _BE_CHECK=$_BE_CHECK
}

_simpleboommeter() {
  # (It's so not)
  # Idea of this is we want a single, multi-faceted function that will handle all boom functionality in a non-native environment
  # The "simple" comes from the fact that it essentially emulates boom patch 1.0 in functionality - no favorite odds, quest, super, drought, etc.

  if [[ "$SESSDOOMBOOM" == "yes" ]]; then return; fi
  if [ -n "$BOOMFIRSTRUN" ]; then
    export BOOMFIRSTRUN=
    readonly BOOM_MAGICPROMPT='\#' &>/dev/null
    function _boomcmdno() {
      # All builtins
      # Can't force containers/hosts to have @P
      local versionX_Y X Y
      versionX_Y=${BASH_VERSION%.*}
      X=${versionX_Y%.*}
      Y=${versionX_Y#*.}
      if ([ $X -eq 4 ] && [ $Y -ge 4 ]) || [ $X -gt 4 ]; then export $1=$(printf '%s' "${BOOM_MAGICPROMPT@P}")
      else export $1=$(HISTTIMEFORMAT= history | tail -n 1 | awk '{print $1}') # this is a number
      fi
    }
    _boomcmdno BOOMPREV_CMDNO
    export BOOMPREV_HISTCMD=$(HISTTIMEFORMAT= history | tail -n 1 | awk '{print $2}') # this is the cmd itself
    [[ ! "$HISTIGNORE" =~ "boomsu" ]] && HISTIGNORE="${HISTIGNORE:+$HISTIGNORE:}boomsu*"
    [[ ! "$HISTIGNORE" =~ "boomssh" ]] && HISTIGNORE="${HISTIGNORE:+$HISTIGNORE:}boomssh*"
    [[ ! "$HISTIGNORE" =~ "boomexec" ]] && HISTIGNORE="${HISTIGNORE:+$HISTIGNORE:}boomexec*"
    [[ ! "$HISTIGNORE" =~ "bringtheboom" ]] && HISTIGNORE="${HISTIGNORE:+$HISTIGNORE:}bringtheboom*"
    [[ ! "$HISTIGNORE" =~ "doom" ]] && HISTIGNORE="${HISTIGNORE:+$HISTIGNORE:}doom*"
    [[ ! "$HISTIGNORE" =~ "boommeter" ]] && HISTIGNORE="${HISTIGNORE:+$HISTIGNORE:}boommeter*"
    alias boommeter='_simpleboommeter' &>/dev/null
    alias doom='export SESSDOOMBOOM=yes; export BOOMFIRSTRUN=doomed; echo No booms for you!' &>/dev/null
    alias bringtheboom='export SESSDOOMBOOM=;' &>/dev/null
    alias boomssh='_simpleboommeter __ssh' &>/dev/null
    alias boomexec='_simpleboommeter __exec' &>/dev/null

    # Completion
    if declare -f __load_completion &>/dev/null; then __load_completion ssh &>/dev/null; fi
    local comp_func=$(sed -ne "s/^complete\( .*\)\{0,1\} -F \(.*\) ssh/\2/p" <(complete -p ssh 2>/dev/null))
    if declare -f $comp_func &>/dev/null; then
      complete -F $comp_func boomssh &>/dev/null
    else
      complete -A hostname boomssh &>/dev/null
    fi
    complete -C '_boomexec() { [ "$3" == "boomexec" ] && command '"$BOOMCONTS"' ps --format='\''{{.Names}}'\'' 2>/dev/null | grep "^$2"; }; _boomexec' boomexec &>/dev/null

    if [ ! -d "/tmp/.$BOOMHOSTUSER/" ]; then mkdir /tmp/.$BOOMHOSTUSER &>/dev/null; fi
    if [ ! -d "/tmp/.$BOOMHOSTUSER/" ]; then export SESSDOOMBOOM=yes; return; fi
    \chmod 777 /tmp/.$BOOMHOSTUSER &>/dev/null

    _boomTracker=/tmp/.$BOOMHOSTUSER/.boomtracker
    if [ ! -f "$_boomTracker" ]; then touch $_boomTracker &>/dev/null; fi
    if [ ! -f "$_boomTracker" ]; then export SESSDOOMBOOM=yes; return; fi
    _boomRankings=/tmp/.$BOOMHOSTUSER/.boomrankings-$BOOMDEST

    if [[ -n "$BOOMSUUSER" && ($UID -eq 0 || "$(whoami)" == "root") ]]; then
      chown -R $BOOMSUUSER:${BOOMSUGROUP:-$BOOMSUUSER} /tmp/.$BOOMHOSTUSER &>/dev/null;
    elif [[ $UID -eq 0 || "$(whoami)" == "root" ]]; then
      :
    else
      alias boomsu='echo "_boomsu" >'"$_boomTracker"'; sudo bash -c "$(declare -f _simpleboommeter _exportEmojis); export -f _simpleboommeter; export -f _exportEmojis; export '"$(_exportEmojis)"'; export BOOMCONTS='"$BOOMCONTS"'; BOOMDEST='"$BOOMDEST"'; export BOOMHOSTUSER='"$BOOMHOSTUSER"'; export PROMPT_COMMAND='"'_simpleboommeter __auto'"'; export BOOMFIRSTRUN=boomsu; export BOOMSUUSER='"${UID:-$(id $USER --user)}"'; export BOOMSUGROUP='"${GID:-$(id $USER --group)}"'; bash -c su; echo "_boomsu" > '"$_boomTracker"'";' &>/dev/null
    fi
  fi
  if [ ! -w "$_boomTracker" ]; then export BOOMFIRSTRUN=fileerased; echo boommeter detected session closure - restarting; return; fi
  \chmod 666 $_boomRankings $_boomTracker &>/dev/null

  local cmd=$(HISTTIMEFORMAT= history | tail -n 1 | awk '{print $2}')
  case $1_ in
    __auto_)
      _boomcmdno BOOM_CMDNO
      if [[ "$(cat $_boomTracker)" =~ ^"_boomsu"$ ]]; then
        if [ $UID -eq 0 ]; then
          # Don't boom after executing (when becoming root)
          cmd=$(HISTTIMEFORMAT= history | tail -n 1 | awk '{print $2}'); echo $cmd > $_boomTracker;
        else
          # Boom on exit (when returning to calling user)
          cmd=boomsu;
        fi
      fi;

      if [[ "$(cat $_boomTracker)" =~ ^"boomsu"$ && "$BOOMPREV_HISTCMD" == "$cmd" ]]; then
        # Need this check bc boomsu is in HISTIGNORE
        # This ensures a new command has been run
        BOOM_CMDNO=$BOOMPREV_CMDNO # skip next if
      fi

      # This magic skips empty lines
      # Skips 1 to preserve legacy (pre-2.2.9) "feature" of booming on terminal start
      # (unsure why first command is 1 and not 0 here)
      if [[ $BOOM_CMDNO -ne $BOOMPREV_CMDNO || $BOOM_CMDNO -eq 1 ]]; then
        if [[ -n "$cmd" && "$(cat $_boomTracker)" != "$cmd" ]]; then
            echo $cmd > $_boomTracker

            local boomrandomizer=$(( $RANDOM % 15 + 1 ))
            if [ $boomrandomizer -eq 7 ]; then
              _simpleboommeter $cmd _log | sed "s|Let's rank it on the|Random|"
            fi
        fi
      fi
      export BOOMPREV_HISTCMD=$(HISTTIMEFORMAT= history | tail -n 1 | awk '{print $2}')
      export BOOMPREV_CMDNO=$BOOM_CMDNO
    ;;
    __exec_)
      if [[ "$SESSDOOMBOOM" == "yes" ]]; then echo bash: boomexec: command not found; return; fi

      if [ -z "$2" ]; then echo Error: requires CONT-NAME; return; fi
      command $BOOMCONTS exec -it $2 bash -c "$(declare -f _simpleboommeter _exportEmojis); export $(_exportEmojis); export BOOMCONTS=\"$BOOMCONTS\"; export BOOMDEST=\"${2#*@}\"; export -f _simpleboommeter; export -f _exportEmojis; export BOOMHOSTUSER=\"$BOOMHOSTUSER\"; export PROMPT_COMMAND='_simpleboommeter __auto'; export BOOMFIRSTRUN=chainexec; bash; _simpleboommeter __export"
    ;;
    __export_)
      if [[ "$-" != "hBc" ]]; then echo Error: do not manually run export; return; fi
      if [ -f $_boomRankings ]; then
        echo "$_BE_BOOM$_BE_EXPORT$_BE_BOOM Exporting booms from $BOOMDEST $_BE_BOOM$_BE_EXPORT$_BE_BOOM"
        echo "$_BE_BOOM host: $BOOMDEST"
        cat $_boomRankings | sed 's/^[^ ]\+/'"$_BE_BOOM"'/'
        echo "$_BE_BOOM$_BE_CHECK$_BE_BOOM Export Complete $_BE_BOOM$_BE_CHECK$_BE_BOOM"
      else
        echo "$_BE_BOOM$_BE_HOLE$_BE_BOOM No booms to export from $BOOMDEST! $_BE_BOOM$_BE_HOLE$_BE_BOOM"
      fi
      if [ -d "/tmp/.$BOOMHOSTUSER" ]; then \rm -rf /tmp/.$BOOMHOSTUSER &>/dev/null; fi
    ;;
    __log_)
      if [[ "$2" =~ [!./]+ ]]; then return; fi
      if [ ! -f "$_boomRankings" ]; then echo "$_BE_BOOM  $2 $3" > $_boomRankings; \chmod 644 $_boomRankings &>/dev/null; return; fi
      local exists=$(sed -ne "/^$_BE_BOOM  $2 /p" $_boomRankings)
      if [ -n "$exists" ]; then
        sed -i "/^$_BE_BOOM  $2 / s|$| $3|" $_boomRankings
      else
        sed -i "$ a \\$_BE_BOOM  $2 $3" $_boomRankings
      fi
    ;;
    __ssh_)
      if [[ "$SESSDOOMBOOM" == "yes" ]]; then echo bash: boomssh: command not found; return; fi

      if [ -z "$2" ]; then echo Error: requires [USER@]HOST arg; return; fi
      \ssh -t $2 "$(declare -f _simpleboommeter _exportEmojis); export -f _simpleboommeter; export -f _exportEmojis; export $(_exportEmojis); export BOOMCONTS=\"$BOOMCONTS\"; export BOOMDEST=\"${2#*@}\"; export BOOMHOSTUSER=\"$BOOMHOSTUSER\"; export PROMPT_COMMAND='_simpleboommeter __auto'; export BOOMFIRSTRUN=chainssh; bash; _simpleboommeter __export"
    ;;
    *_)
      # If command includes super problematic chars just exit
      if [[ "$2" == "_log" && "$1" =~ [![]+ ]]; then return; fi

      # Adapted from Josh
      if [ -z "$1" ]; then
        echo "Give us something to rank on the boom meter!"
        return 1
      fi

      local score=$(( $RANDOM % 8 + 1 ))
      local dispscore=$score
      local result=""

      if [ $score -gt 5 ] ; then
        score=5
        dispscore=5
      fi

      for i in $(seq 1 $score); do
        result+="$_BE_BOOM"
      done

      local term
      if [[ "$2" == "_log" ]]; then
        if [[ "$1" =~ ^[^!/.[\"\']+$ ]]; then
          _simpleboommeter __log $1 $score
          term=${1}
        else return; fi
      else term="$@"
      fi

      echo "Let's rank it on the boom meter! $term gets $dispscore big boom$([ $score -gt 1 ] && echo s)! $result"
    ;;
  esac
}

###Function boomexec
###Function boomssh
###ExcFunction boomsu
# "\t${B}boom${N}{${B}exec${N} | ${B}ssh${N}} [USER${B}@${N}]NAME [START-DIR]";
# "\t\tssh as USER or ${BOOMCONTS} exec to host/container at NAME, bringing the boom in and out with you!";
# "\t\tthe created session will cd to START-DIR on startup if provided";
# "\t\tthese functions will allow you to randomly boom in a foreign environment";
# "\t\tboomexec and boomssh can be chained together to export booms from multiple hosts/containers in one session";
# "\t\tthis is enabled by exporting a stripped down version of _boommeter at each new login";
# "\t\tenabled commands in this \"simple\" mode are:";
# "\n\t\t${B}boomsu${N}\n\t\t\trun sudo su, but maintain the boom session as root";
# "\t\t${B}boom${N}{${B}exec${N} | ${B}ssh${N}} [USER${B}@${N}]NAME\n\t\t\tchain exec/ssh to export booms from anywhere";
# "\t\t${B}doom${N}\n\t\t\tturn off the random boom meter and disable commands";
# "\t\t${B}bringtheboom${N}\n\t\t\tresume the random boom meter";
# "\t\t${B}boommeter${N} THING\n\t\t\trank THING on the boom meter!";
# "\n\t\tbooms acquired while away from home will be exported on exits and imported back to local rankings on origin session closure!";
# "\t\tbooms acquired while away from home will count towards favorite entries if the favorite has been decided for the day";
# "\t\ta boom exec/ssh session is similar to patch 1.0.0 - you will not see 6 booms, super booms, droughts, favorite odds, or quests";
# "\t\tdynamic completion allows boomexec/boomssh to be completed both locally and in launched sessions!";
# "\t\tall boom-related functions, env variables, and files are removed/destroyed on session closure";
# "\t\tall boom-related commands are hidden from history in open sessions, but boomsu is still able to be boomed!";
###
alias boomssh='_boomsession _boomssh'
alias boomexec='_boomsession _boomexec'
_boomexec() {
  DBUS_SESSION_BUS_ADDRESS= command $BOOMCONTS exec -it $1 bash -c "$(declare -f _simpleboommeter _exportEmojis); export $(_exportEmojis); export BOOMCONTS=\"$BOOMCONTS\"; export BOOMDEST=\"${1#*@}\"; export -f _simpleboommeter; export -f _exportEmojis; export BOOMHOSTUSER=\"$USER\"; export PROMPT_COMMAND='_simpleboommeter __auto'; export BOOMFIRSTRUN=yes; ${2:+cd $2; }bash; _simpleboommeter __export" | tee >(\grep -I --line-buffered ^"$_BE_BOOM" >> $_boomSession)
}
_boomssh() {
  # Not currently handling conflicting user sessions besides root
  if [[ "${1%@*}" == "root" ]]; then
    echo "WARNING: A boom session created by root can break access to boom tracking files for other users. Be careful with multiple sessions."
    echo "         To avoid conflict, you need to have already boomed in the non-root user session on the host or use \`boomsu\` instead."
  fi
  \ssh -tX $1 "$(declare -f _simpleboommeter _exportEmojis); export -f _simpleboommeter; export -f _exportEmojis; export $(_exportEmojis); export BOOMCONTS=\"$BOOMCONTS\"; export BOOMDEST=\"${1#*@}\"; export BOOMHOSTUSER=\"$USER\"; export PROMPT_COMMAND='_simpleboommeter __auto'; export BOOMFIRSTRUN=yes; ${2:+cd $2; }bash; _simpleboommeter __export" | tee >(\grep -I --line-buffered ^"$_BE_BOOM" >> $_boomSession)
}
_boomsession() {
  local callerfunc=${FUNCNAME[-1]} # forgot to make use of this but it's cool so here it is - should be == to ${1#_} here
  if [[ ! " _boomssh _boomexec " =~ " $1 " ]]; then echo bash: _boomsession: command not found; return; fi # handling it like this just bc it's kind of funny

  if [[ "$DOOMBOOM" == "yes" ]]; then echo bash: ${1#_}: command not found; return; fi
  if [ "$_SILENTBOOM" == "yes" ]; then echo ${1#_}: cannot run with boom silent on; return; fi

  if [ -z "$2" ]; then echo Error: requires [USER@]host/container NAME arg; return; fi
  $1 $2 $3
  if [ ! -f $_boomSession ]; then echo Error exporting boom ${1#_boom} rankings; return; fi
  if [ ! -r $_boomSession ]; then echo Error reading boom ${1#_boom} rankings; return; fi
  cat $_boomSession | sed -ne "\|$_BE_BOOM$_BE_EXPORT$_BE_BOOM Exporting .* $_BE_BOOM$_BE_EXPORT$_BE_BOOM|,\|$_BE_BOOM$_BE_CHECK$_BE_BOOM Export Complete $_BE_BOOM$_BE_CHECK$_BE_BOOM|p" | tail -n +2 | head -n -1 | sed -e 's/^'"$_BE_BOOM"' //' -e 's///g' | grep -v "$_BE_BOOM" > $_boomImportReady
  echo -n "" > $_boomSession
}

_checkForBoomImports() {
  local remotehost ranks cmd line score prefix currtot
  local files=()
  filesboomed=0
  if [ -r $_boomImportReady ]; then
    prefix=~/$BOOMINSTALL/.boomimport/.import-
    files=($(csplit $_boomImportReady -z -f $prefix '/host:.*/' '{*}'))

    if [ -r $_boomRankings ]; then
      currtot=$(($(wc -w $_boomRankings | awk '{print $1}')-$(wc -l $_boomRankings | awk '{print $1}')))
    else
      currtot=0
    fi

    for name in $(seq -f '%02.0f' 0 $((${#files[@]}-1))); do
      filename=$prefix$name
      remotehost=$(sed -ne 's/^host: \(.*\)$/\1/p' $filename)
      ranks=0
      while read line; do
        cmd=$(echo ${line%% *})
        for score in ${line#* }; do
          # Write to log
          ranks=$(($ranks+1))
          currtot=$(($currtot+1))
          if [[ "$(($currtot%25))" == "0" ]]; then
            echo "Congratulations! You have boomed $currtot times!"
          fi
          _boomlog $cmd $score $remotehost

          # Add entry for favor drawing if favor has been rolled for the day
          if [ -w $_boomFavor ] && [ "$(TZ=$BOOMTZ date -d @$(stat -c %Y $_boomFavor) +%d)" == "$(TZ=$BOOMTZ date +%d)" ]; then
            sed -i "2 s/$/ $USER/" $_boomFavor
          fi
        done
      done < <(sed -ne '\|^ [^ ]\+ [0-9 ]\+|p' $filename)
      if [[ $ranks -gt 0 && -w "$_boomUserLog" ]]; then
        echo "$_BE_BOOM$_BE_IMPORT$_BE_BOOM $USER imported $ranks boom$([ $ranks -gt 1 ] && echo s) from ${remotehost}! $_BE_BOOM$_BE_IMPORT$_BE_BOOM" >> $_boomUserLog
        echo $_BE_BOOM$_BE_IMPORT$_BE_BOOM Imported $ranks boom$([ $ranks -gt 1 ] && echo s) from $remotehost! $_BE_BOOM$_BE_IMPORT$_BE_BOOM
      elif [ $ranks -eq 0 ]; then echo "$_BE_BOOM$_BE_HOLE$_BE_BOOM No booms to import from $remotehost! $_BE_BOOM$_BE_HOLE$_BE_BOOM" # This shouldn't happen with skipping empty exports
      elif [ ! -w "$_boomUserLog" ]; then
        echo $_BE_BOOM$_BE_IMPORT$_BE_BOOM Imported $ranks boom$([ $ranks -gt 1 ] && echo s) from $remotehost! $_BE_BOOM$_BE_IMPORT$_BE_BOOM
        echo Error: unable to write to site log
      fi
      if [[ $ranks -gt 0 ]]; then filesboomed=$(($filesboomed+1)); fi
      rm $filename
    done
    rm $_boomImportReady
    if [ $filesboomed -gt 1 ]; then
      echo $_BE_BOOM⛓️ $_BE_BOOM Import chain! $_BE_BOOM⛓️ $_BE_BOOM
      echo "$_BE_BOOM⛓️$_BE_BOOM $USER is chaining boom imports! $_BE_BOOM⛓️$_BE_BOOM" >> $_boomUserLog
    fi

    # Reset streak
    echo -n "" > $_boomStreak
  fi
}
#TODO: fxn that exports booms from current session elsewhere?
# ^ .sessionlog or whatever gets parsed as exports happen or something if a session dies but had an export instead of having to open/close a different session to import

# Completion - not checking for doom here but it's probably fine
if declare -f __load_completion &>/dev/null; then __load_completion ssh; fi
comp_func=$(sed -ne "s/^complete\( .*\)\{0,1\} -F \(.*\) ssh/\2/p" <(complete -p ssh 2>/dev/null))
if declare -f $comp_func &>/dev/null; then
  complete -F $comp_func boomssh &>/dev/null
else
  complete -A hostname boomssh &>/dev/null
fi
unset comp_func
complete -C '__boomexec() { [ "$3" == "boomexec" ] && command '"$BOOMCONTS"' ps --format='\''{{.Names}}'\'' 2>/dev/null | grep "^$2"; }; __boomexec' boomexec &>/dev/null

# Handle if files inaccessible but host accessed with boomsession
if [[ "$DOOMBOOM" == "yes" && -n "$BOOMHOSTUSER" ]]; then
  export PROMPT_COMMAND='_simpleboommeter __auto'
  export BOOMFIRSTRUN=badhost
fi

